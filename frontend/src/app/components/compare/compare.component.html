<div class="container">
  <h1>
    <button mat-icon-button routerLink="/products">
      <mat-icon>arrow_back</mat-icon>
    </button>
    Compare Products
  </h1>

  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading && product1 && product2) {
    <div class="compare-table">
      <!-- Header Row with Products -->
      <div class="compare-row header-row">
        <div class="compare-label"></div>
        <div class="compare-cell">
          <img [src]="product1.imageUrl" [alt]="product1.name" (click)="viewProduct(getProductId(product1))" (error)="$any($event.target).src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27 viewBox=%270 0 300 300%27%3E%3Crect fill=%27%23f5f5f5%27 width=%27300%27 height=%27300%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27%3ENo Image%3C/text%3E%3C/svg%3E'">
          <h3 (click)="viewProduct(getProductId(product1))">{{ product1.name }}</h3>
          <button mat-raised-button color="primary" (click)="addToCart(product1)" [disabled]="getProductStock(product1) === 0">
            <mat-icon>add_shopping_cart</mat-icon>
            {{ getProductStock(product1) === 0 ? 'Out of Stock' : 'Add to Cart' }}
          </button>
        </div>
        <div class="compare-cell">
          <img [src]="product2.imageUrl" [alt]="product2.name" (click)="viewProduct(getProductId(product2))" (error)="$any($event.target).src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27 viewBox=%270 0 300 300%27%3E%3Crect fill=%27%23f5f5f5%27 width=%27300%27 height=%27300%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27%3ENo Image%3C/text%3E%3C/svg%3E'">
          <h3 (click)="viewProduct(getProductId(product2))">{{ product2.name }}</h3>
          <button mat-raised-button color="primary" (click)="addToCart(product2)" [disabled]="getProductStock(product2) === 0">
            <mat-icon>add_shopping_cart</mat-icon>
            {{ getProductStock(product2) === 0 ? 'Out of Stock' : 'Add to Cart' }}
          </button>
        </div>
      </div>

      <!-- Comparison Rows -->
      @for (row of comparisonRows; track row.key) {
        <div class="compare-row">
          <div class="compare-label">{{ row.label }}</div>
          <div class="compare-cell" [class.better]="isBetter(row.key, getValue(product1, row.key), getValue(product2, row.key)) === 'product1'">
            @if (row.format === 'rating') {
              <div class="rating">
                @for (star of [1,2,3,4,5]; track star) {
                  <mat-icon>{{ star <= getProductRating(product1) ? 'star' : 'star_border' }}</mat-icon>
                }
                <span>({{ getValue(product1, 'reviewCount') ?? 0 }})</span>
              </div>
            } @else {
              {{ formatValue(getValue(product1, row.key), row.format) }}
            }
          </div>
          <div class="compare-cell" [class.better]="isBetter(row.key, getValue(product1, row.key), getValue(product2, row.key)) === 'product2'">
            @if (row.format === 'rating') {
              <div class="rating">
                @for (star of [1,2,3,4,5]; track star) {
                  <mat-icon>{{ star <= getProductRating(product2) ? 'star' : 'star_border' }}</mat-icon>
                }
                <span>({{ getValue(product2, 'reviewCount') ?? 0 }})</span>
              </div>
            } @else {
              {{ formatValue(getValue(product2, row.key), row.format) }}
            }
          </div>
        </div>
      }

      <!-- Description Row -->
      <div class="compare-row description-row">
        <div class="compare-label">Description</div>
        <div class="compare-cell">{{ product1.description }}</div>
        <div class="compare-cell">{{ product2.description }}</div>
      </div>
    </div>
  }
</div>
