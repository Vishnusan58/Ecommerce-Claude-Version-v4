<div class="container">
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading && product) {
    <div class="product-detail">
      <!-- Image Gallery -->
      <div class="image-section">
        <div class="main-image">
          @if (product.premiumEarlyAccess) {
            <div class="premium-badge">Premium Early Access</div>
          }
          @if (discountPercent > 0) {
            <div class="discount-badge">-{{ discountPercent }}%</div>
          }
          <img [src]="selectedImage" [alt]="product.name" (error)="$any($event.target).src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27 viewBox=%270 0 300 300%27%3E%3Crect fill=%27%23f5f5f5%27 width=%27300%27 height=%27300%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27%3ENo Image%3C/text%3E%3C/svg%3E'">
        </div>
        @if (allImages.length > 1) {
          <div class="thumbnail-list">
            @for (img of allImages; track img) {
              <img [src]="img" [alt]="product.name" (click)="selectImage(img)" [class.selected]="img === selectedImage" (error)="$any($event.target).src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27 viewBox=%270 0 300 300%27%3E%3Crect fill=%27%23f5f5f5%27 width=%27300%27 height=%27300%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2716%27%3ENo Image%3C/text%3E%3C/svg%3E'">
            }
          </div>
        }
      </div>

      <!-- Product Info -->
      <div class="info-section">
        <mat-chip-set>
          <mat-chip>{{ getProductCategory() }}</mat-chip>
          @if (product.brand) {
            <mat-chip>{{ product.brand }}</mat-chip>
          }
        </mat-chip-set>

        <h1 class="product-name">{{ product.name }}</h1>

        <div class="rating">
          @for (star of [1,2,3,4,5]; track star) {
            <mat-icon>{{ star <= getProductRating() ? 'star' : 'star_border' }}</mat-icon>
          }
          <span>{{ getProductRating() }}/5 ({{ getReviewCount() }} reviews)</span>
        </div>

        <div class="price-section">
          <span class="price">₹{{ product.price | number }}</span>
          @if (product.originalPrice && product.originalPrice > product.price) {
            <span class="original-price">₹{{ product.originalPrice | number }}</span>
            <span class="discount">Save ₹{{ (product.originalPrice - product.price) | number }}</span>
          }
        </div>

        <p class="stock-status" [class.out-of-stock]="getProductStock() === 0">
          @if (getProductStock() > 0) {
            <mat-icon>check_circle</mat-icon>
            In Stock ({{ getProductStock() }} available)
          } @else {
            <mat-icon>cancel</mat-icon>
            Out of Stock
          }
        </p>

        <div class="quantity-section">
          <label>Quantity:</label>
          <div class="quantity-controls">
            <button mat-icon-button (click)="decrementQuantity()" [disabled]="quantity <= 1">
              <mat-icon>remove</mat-icon>
            </button>
            <span class="quantity">{{ quantity }}</span>
            <button mat-icon-button (click)="incrementQuantity()" [disabled]="quantity >= getProductStock()">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>

        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="addToCart()" [disabled]="getProductStock() === 0" class="add-to-cart-btn">
            <mat-icon>add_shopping_cart</mat-icon>
            Add to Cart
          </button>
          <button mat-stroked-button (click)="toggleWishlist()" [color]="isInWishlist ? 'warn' : ''">
            <mat-icon>{{ isInWishlist ? 'favorite' : 'favorite_border' }}</mat-icon>
            {{ isInWishlist ? 'In Wishlist' : 'Add to Wishlist' }}
          </button>
        </div>

        <p class="seller-info">
          <mat-icon>store</mat-icon>
          Sold by: {{ product.sellerName || product.seller?.name || 'Unknown Seller' }}
        </p>
      </div>
    </div>

    <!-- Tabs for Description and Reviews -->
    <mat-tab-group class="mt-3">
      <mat-tab label="Description">
        <div class="tab-content">
          <p>{{ product.description }}</p>
        </div>
      </mat-tab>
      <mat-tab label="Reviews ({{ getReviewCount() }})">
        <div class="tab-content">
          <app-reviews [productId]="getProductId()"></app-reviews>
        </div>
      </mat-tab>
    </mat-tab-group>
  }
</div>
